import { Markup, Telegraf } from "telegraf";
import { Command } from "./command.class";
import { Review, IBotContext } from "../context/context.interface";
import { CallbackQuery } from "telegraf/typings/core/types/typegram";
import pool from "../db/db.config";

export class IndexCommand extends Command {
  constructor(bot: Telegraf<IBotContext>) {
    super(bot);
  }

  handle(): void {
    this.bot.action("reviews_list", async (ctx) => {
      const username = ctx.from?.username;
      if (username) {
        const reviews = await this.showReviews(username);

        if (reviews.length > 0) {
          const buttons = reviews.map((review) =>
            Markup.button.callback(
              `${review.type} "${review.title}" ‚û°Ô∏è`,
              `review_${review.id}`,
            ),
          );

          const inlineKeyboard = Markup.inlineKeyboard([
            [Markup.button.callback("‚¨ÖÔ∏è –í –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", "back_to_menu")],
            ...buttons.map((button) => [button]),
          ]);

          await ctx.editMessageText("–í–∞—à–∏ –æ–±–∑–æ—Ä—ã:", inlineKeyboard);
        } else {
          await ctx.editMessageText(
            "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –æ–±–∑–æ—Ä–æ–≤.",
            Markup.inlineKeyboard([
              [Markup.button.callback("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "back_to_menu")],
            ]),
          );
        }
      } else {
        await ctx.reply("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.");
      }
    });

    this.bot.action("back_to_menu", async (ctx) => {
      await ctx.editMessageText(
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        Markup.inlineKeyboard([
          [Markup.button.callback("üóÇÔ∏è –°–ø–∏—Å–æ–∫ –æ–±–∑–æ—Ä–æ–≤", "reviews_list")],
          [Markup.button.callback("‚ûï –î–æ–±–∞–≤–∏—Ç—å –æ–±–∑–æ—Ä", "add_review")],
        ]),
      );
    });

    this.bot.action(/^review_\d+$/, async (ctx) => {
      const callbackQuery = ctx.callbackQuery as CallbackQuery;

      if ("data" in callbackQuery) {
        const reviewId = parseInt(callbackQuery.data.split("_")[1]);
        const review = await this.showReview(reviewId);
        ctx.session.review = review;

        ctx.editMessageText(
          `–û–±–∑–æ—Ä –Ω–∞ ${review.type} "${review.title}" \n–° —Ä–µ–π—Ç–∏–≥–æ–º ${review.rating}/10 \n–í –∂–∞–Ω—Ä–µ ${review.genre}`,
          Markup.inlineKeyboard([
            [Markup.button.callback("‚¨ÖÔ∏è –ù–∞–∑–∞–¥", "reviews_list")],
            [Markup.button.callback("‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–π—Ç–∏–Ω–≥", "edit_review_rating")],
            [Markup.button.callback("üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –æ–±–∑–æ—Ä", "delete_review")],
            [Markup.button.callback("üóÇÔ∏èüë• –û–±–∑–æ—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π", "users_review")],
          ]),
        );
      }
    });
  }

  private async showReviews(username: string): Promise<Review[]> {
    const query = `
      SELECT * FROM reviews
      WHERE username = $1
    `;

    try {
      const client = await pool.connect();
      const result = await client.query(query, [username]);
      client.release();
      return result.rows;
    } catch (err) {
      console.error(err);
      return [];
    }
  }

  private async showReview(id: number) {
    const query = `
      SELECT * FROM reviews
      WHERE id = $1
    `;

    try {
      const client = await pool.connect();
      const result = await client.query(query, [id]);
      client.release();
      return result.rows[0];
    } catch (err) {
      console.error(err);
      return [];
    }
  }
}
